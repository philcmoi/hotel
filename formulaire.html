<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Réservation Hôtel - Calendrier</title>
    <style>
      /******************************* DEBUT CSS *************************************************/
      
      /*******************************************************************************************/
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        top: 0px;
        padding: 0px;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 2rem;
      }

      .reservation {
        background: #4caf50;
        color: white;
        padding: 2px 5px;
        margin: 2px 0;
        border-radius: 3px;
        font-size: 0.8em;
        cursor: pointer;
      }

      .reservation.chambre-1 {
        background: #4caf50;
      }
      .reservation.chambre-2 {
        background: #2196f3;
      }
      .reservation.chambre-3 {
        background: #ff9800;
      }

      .booking-form {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
      }

      .chambre-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .chambre-card {
        border: 2px solid #ddd;
        padding: 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .chambre-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .chambre-card.unavailable {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.3s ease;
      }

      .btn:hover {
        background: #5a6fd8;
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .availability-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 5px;
        display: none;
      }

      .availability-result.available {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .availability-result.unavailable {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
      }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
/*****************************************  FIN CSS  *********************************************/
/*************************************************************************************************/
</style>
  
</head>

<!--************************************ DEBUT HTML *********************************************-->
<!--*********************************************************************************************-->

<body>
  <section class="booking-form">
        <h2>Recherche chambres disponible</h2>
        <form id="reservation-form">
          <div class="form-group">
            <label>Dates de séjour</label>
            <div style="display: flex; gap: 10px">
              <input type="date" id="date-arrivee" required />
              <input type="date" id="date-depart" required />
            </div>
          </div>

          <div class="form-group">
            <label>Vérifier la disponibilité</label>
            <button type="button" onclick="checkAvailability()" class="btn">
              Vérifier
            </button>
          </div>

          <div id="availability-result" class="availability-result"></div>

          <div class="form-group">
            <label>Chambres disponibles</label>
            <div id="chambre-selection" class="chambre-selection">
              <!-- Les chambres seront chargées ici -->
            </div>
          </div>

          <div class="form-group">
            <label>Informations personnelles</label>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <input type="text" id="nom" placeholder="Nom *" required />
              <input type="text" id="prenom" placeholder="Prénom *" required />
            </div>
          </div>

          <div class="form-group">
            <input type="email" id="email" placeholder="Email *" required />
          </div>

          <div class="form-group">
            <input type="tel" id="telephone" placeholder="Téléphone *" required />
          </div>

          <div class="form-group">
            <textarea
              id="adresse"
              placeholder="Adresse *"
              rows="3"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <input
              type="number"
              id="nombre-personnes"
              placeholder="Nombre de personnes *"
              min="1"
              required
            />
          </div>

          <div class="form-group">
            <textarea
              id="commentaire"
              placeholder="Commentaires ou demandes spéciales"
              rows="3"
            ></textarea>
          </div>

          <button type="submit" class="btn" id="submit-btn" disabled>
            Réserver
          </button>
        </form>
      </section>
    </div>

    <div id="reservation-modal" class="modal">
      <div class="modal-content">
        <h3>Réservation confirmée</h3>
        <p id="confirmation-message"></p>
        <button onclick="closeModal()" class="btn">Fermer</button>
      </div>
    </div>
  </div>
</div>
</body>

<script>
  /**************************************  JAVASCRIPT  ******************************************/

  /*********************************** DEBUT TRAITEMENT RESERVATION ******************************************/   
  
    class ReservationCalendar {
        constructor() {
          this.currentDate = new Date();
          this.selectedChambres = [];
          this.chambres = [];
          this.init();
        }

        init() {
          this.loadChambres();
          this.loadReservations();
          this.setupEventListeners();
        }

        loadChambres() {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', 'reservation.php?action=get_chambres', true);
          xhr.onreadystatechange = () => {
            if (xhr.readyState === 4 && xhr.status === 200) {
              try {
                this.chambres = JSON.parse(xhr.responseText);
                this.renderChambreSelection();
              } catch (error) {
                console.error("Erreur chargement chambres:", error);
              }
            }
          };
          xhr.onerror = () => {
            console.error("Erreur réseau lors du chargement des chambres");
          };
          xhr.send();
        }

        loadReservations() {
          const month = this.currentDate.getMonth() + 1;
          const year = this.currentDate.getFullYear();
          
          const xhr = new XMLHttpRequest();
          xhr.open('GET', `reservation.php?action=get_reservations&month=${month}&year=${year}`, true);
          xhr.onreadystatechange = () => {
            if (xhr.readyState === 4 && xhr.status === 200) {
              try {
                const reservations = JSON.parse(xhr.responseText);
                this.displayReservations(reservations);
              } catch (error) {
                console.error("Erreur chargement réservations:", error);
              }
            }
          };
          xhr.onerror = () => {
            console.error("Erreur réseau lors du chargement des réservations");
          };
          xhr.send();
        }


        displayReservations(reservations) {
          reservations.forEach((reservation) => {
            const arrivee = new Date(reservation.date_arrivee);
            const depart = new Date(reservation.date_depart);

            // Parcourir tous les jours entre arrivee et depart
            for (
              let d = new Date(arrivee);
              d < depart;
              d.setDate(d.getDate() + 1)
            ) {
              const dayElement = document.querySelector(
                `[data-date="${d.toISOString().split("T")[0]}"]`
              );
              if (dayElement) {
                const reservationElement = document.createElement("div");
                reservationElement.className = `reservation chambre-${reservation.idChambre}`;
                reservationElement.title = `${reservation.type_chambre} - ${reservation.prenom} ${reservation.nom}`;
                reservationElement.textContent = `Ch. ${reservation.numeroChambre}`;
                dayElement.appendChild(reservationElement);
              }
            }
          });
        }

        renderChambreSelection() {
          const container = document.getElementById("chambre-selection");
          container.innerHTML = this.chambres
            .map(
              (chambre) => `
                    <div class="chambre-card" data-id="${chambre.idChambre}" onclick="calendar.selectChambre(${chambre.idChambre})">
                        <h4>Chambre ${chambre.numeroChambre}</h4>
                        <p>Type: ${chambre.type_chambre}</p>
                        <p>Capacité: ${chambre.capacite} personnes</p>
                        <p>Prix: ${chambre.prix_nuit}€/nuit</p>
                    </div>
                `
            )
            .join("");
        }

        selectChambre(chambreId) {
          const card = document.querySelector(`[data-id="${chambreId}"]`);
          if (card.classList.contains("unavailable")) return;

          const index = this.selectedChambres.indexOf(chambreId);
          if (index > -1) {
            this.selectedChambres.splice(index, 1);
            card.classList.remove("selected");
          } else {
            this.selectedChambres.push(chambreId);
            card.classList.add("selected");
          }

          this.updateSubmitButton();
        }

        updateSubmitButton() {
          const submitBtn = document.getElementById("submit-btn");
          submitBtn.disabled = this.selectedChambres.length === 0;
        }

        setupEventListeners() {
          document
            .getElementById("reservation-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.submitReservation();
            });
        }

        submitReservation() {
          const formData = {
            nom: document.getElementById("nom").value,
            prenom: document.getElementById("prenom").value,
            email: document.getElementById("email").value,
            telephone: document.getElementById("telephone").value,
            adresse: document.getElementById("adresse").value,
            date_arrivee: document.getElementById("date-arrivee").value,
            date_depart: document.getElementById("date-depart").value,
            nombre_personnes: document.getElementById("nombre-personnes").value,
            commentaire: document.getElementById("commentaire").value,
            chambres: this.selectedChambres,
          };

          const xhr = new XMLHttpRequest();
          xhr.open('POST', 'reservation.php', true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          
          xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                try {
                  const result = JSON.parse(xhr.responseText);
                  if (result.success) {
                    this.showConfirmation(result.reservation_id);
                    this.resetForm();
                    this.loadReservations();
                  } else {
                    alert("Erreur: " + result.error);
                  }
                } catch (error) {
                  console.error("Erreur parsing réponse:", error);
                  alert("Erreur lors de la réservation");
                }
              } else {
                alert("Erreur réseau lors de la réservation");
              }
            }
          };
          
          xhr.onerror = () => {
            alert("Erreur réseau lors de la réservation");
          };
          
          xhr.send(JSON.stringify({
            action: "create_reservation",
            data: formData
          }));
        }

        showConfirmation(reservationId) {
          document.getElementById(
            "confirmation-message"
          ).textContent = `Votre réservation #${reservationId} a été créée avec succès!`;
          document.getElementById("reservation-modal").style.display = "flex";
        }

        resetForm() {
          document.getElementById("reservation-form").reset();
          this.selectedChambres = [];
          this.renderChambreSelection();
          this.updateSubmitButton();
        }

        changeMonth(direction) {
                this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                this.generateCalendar();
                this.loadReservations();
        }

        goToToday() {
                this.currentDate = new Date();
                this.generateCalendar();
                this.loadReservations();
        }
    }

      // Fonctions globales *************************************************
let calendar;

const aujourdhui = new Date();
const autreDate = new Date('2023-12-05');

function differenceEnJours(date1, date2) {
    const unJour = 1000 * 60 * 60 * 24; // milliseconds dans un jour
    
    // Normaliser les dates à minuit
    const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
    const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
    
    const differenceMs = d2.getTime() - d1.getTime();
    return Math.round(differenceMs / unJour);
}

function checkAvailability() {
    const dateArrivee = document.getElementById("date-arrivee").value;
    const dateDepart = document.getElementById("date-depart").value;
        
    if (!dateArrivee || !dateDepart) {
        alert("Veuillez sélectionner les dates");
        return;
    }

    if (dateArrivee > dateDepart) {
        alert("Dates illogiques");
        return;
    }

    const aujourdhui = new Date();
    const Darrivee = new Date(dateArrivee);
    const Ddepart = new Date(dateDepart);

    const joursDifference = differenceEnJours(aujourdhui, Darrivee);

    if (joursDifference < 0) {
        alert("Dates passées");
        return;
    }

    const joursDifference2 = differenceEnJours(aujourdhui, Ddepart);

    if (joursDifference2 < 0) {
        alert("Dates passées");
        return;
    }
  
    const xhr = new XMLHttpRequest();
    xhr.open('GET', `reservation.php?action=check_availability&date_arrivee=${dateArrivee}&date_depart=${dateDepart}`, true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                const availableChambres = JSON.parse(xhr.responseText);
                const resultDiv = document.getElementById("availability-result");
                const chambreCards = document.querySelectorAll(".chambre-card");

                // Réinitialiser l'affichage
                chambreCards.forEach((card) => {
                    card.classList.remove("unavailable", "selected");
                });

                if (availableChambres.length > 0) {
                    resultDiv.className = "availability-result available";
                    resultDiv.innerHTML = `<strong>Chambres disponibles:</strong> ${availableChambres.length} chambre(s) trouvée(s)`;
                    resultDiv.style.display = "block";

                    // Marquer les chambres non disponibles
                    const availableIds = availableChambres.map((ch) => ch.idChambre);
                    chambreCards.forEach((card) => {
                        const chambreId = parseInt(card.dataset.id);
                        if (!availableIds.includes(chambreId)) {
                            card.classList.add("unavailable");
                        }
                    });
                } else {
                    resultDiv.className = "availability-result unavailable";
                    resultDiv.innerHTML = "Aucune chambre disponible pour ces dates";
                    resultDiv.style.display = "block";
                    chambreCards.forEach((card) => card.classList.add("unavailable"));
                }
            } catch (error) {
                console.error("Erreur vérification disponibilité:", error);
            }
        }
    };
    
    xhr.onerror = function() {
        alert("Erreur réseau lors de la vérification de disponibilité");
    };
    
    xhr.send();
}

      function closeModal() {
        document.getElementById("reservation-modal").style.display = "none";
      }

      function changeMonth(direction) {
        calendar.changeMonth(direction);
      }

      function goToToday() {
        calendar.goToToday();
      }

      // Initialisation
      document.addEventListener("DOMContentLoaded", () => {
        calendar = new ReservationCalendar();
      });
    </script>


  </body>